<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Mulberry Leaf Inspector</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      .img-preview { max-width: 100%; height: auto; border: 1px solid #ddd; padding: 4px; background: #fff; }
      .hidden { display: none; }
    </style>
  </head>
  <body class="bg-light">
    <nav class="navbar navbar-light bg-white mb-4">
      <div class="container">
        <span class="navbar-brand">Mulberry Leaf Inspector</span>
        <div><small>Mulberry Leaf Inspection System</small></div>
      </div>
    </nav>
    <div class="container">
      
      <div class="card p-4" id="upload-card">
        <h5>Upload an image of a mulberry leaf for prediction üçÉ</h5>
        <form id="uploadForm" onsubmit="handleUpload(event)">
          <div class="mb-3">
            <input class="form-control" type="file" id="fileInput" accept="image/*" required>
          </div>
          <button class="btn btn-primary" type="submit" id="uploadBtn" disabled>Upload & Predict</button>
        </form>
        <div id="loadingMessage" class="mt-3 hidden">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            Processing image and predicting...
        </div>
      </div>

      <div class="card p-4 mt-4 hidden" id="result-card">
        <h5>Prediction Results ‚ú®</h5>
        <div class="row">
          <div class="col-md-6">
            <h6>Uploaded Image</h6>
            <img id="uploadedImage" class="img-preview" alt="Uploaded Mulberry Leaf">
          </div>
          <div class="col-md-6">
            <h6>Prediction Confidence Chart</h6>
            <canvas id="predictionChart"></canvas>
            <hr>
            
            <h5 class="text-primary">Top prediction: <span class="fw-bold" id="topClass"></span></h5>
            <p id="recommendationText"></p>
            <hr>
            
            <h6>All class probabilities</h6>
            <ul id="allProbsList" class="list-unstyled">
              </ul>
            <button class="btn btn-secondary" onclick="resetPage()">Predict another</button>
          </div>
        </div>
      </div>
      
    </div>

    <script>
        const API_ENDPOINT = 'https://g3weds.consolutechcloud.com/backend/predict';
        const recommendationMap = {
          'Fungal leaves': '‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡πÅ‡∏¢‡∏Å‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏•‡∏≤‡∏¢/‡πÄ‡∏ú‡∏≤‡∏ó‡∏¥‡πâ‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ä‡πà‡πÉ‡∏ô‡∏™‡∏≤‡∏£‡∏Å‡∏≥‡∏à‡∏±‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏£‡∏≤ ‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏ô‡∏≥‡πÑ‡∏õ‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡πÑ‡∏´‡∏°‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á',
        'Good leaves': '‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡πÑ‡∏´‡∏°‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏î‡∏µ',
        'Insect-eaten leaves': '‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏Ñ‡∏±‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ö‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå ‡πÉ‡∏ä‡πâ‡∏°‡∏≤‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏°‡∏•‡∏á ‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏≤‡∏£‡∏ä‡∏µ‡∏ß‡∏†‡∏±‡∏ì‡∏ë‡πå'
        };
        const classNames = ['Fungal leaves', 'Good leaves', 'Insect-eaten leaves'];
        
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadCard = document.getElementById('upload-card');
        const resultCard = document.getElementById('result-card');
        const loadingMessage = document.getElementById('loadingMessage');
        const uploadedImage = document.getElementById('uploadedImage');
        const topClassSpan = document.getElementById('topClass');
        const recommendationP = document.getElementById('recommendationText');
        const allProbsList = document.getElementById('allProbsList');
        let chartInstance = null; // To hold the Chart.js instance

        // Enable/Disable button
        fileInput.addEventListener('change', (event) => {
            uploadBtn.disabled = event.target.files.length === 0;
        });

        function resetPage() {
            uploadCard.classList.remove('hidden');
            resultCard.classList.add('hidden');
            fileInput.value = ''; // Clear file input
            uploadBtn.disabled = true;
            if (chartInstance) {
                chartInstance.destroy();
                chartInstance = null;
            }
        }

        function createChart(probs) {
            const ctx = document.getElementById('predictionChart').getContext('2d');
            
            // Prepare data: combine names and probs, then sort (optional but good practice)
            const combined = classNames.map((name, i) => ({ name, prob: probs[i] }));
            combined.sort((a, b) => b.prob - a.prob);

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: combined.map(item => item.name),
                    datasets: [{
                        label: 'Confidence (%)',
                        data: combined.map(item => item.prob * 100),
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.6)',
                            'rgba(75, 192, 192, 0.6)',
                            'rgba(255, 159, 64, 0.6)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(255, 159, 64, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y', // Horizontal bars
                    responsive: true,
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            title: { display: true, text: 'Probability (%)' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Prediction Confidence' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.x.toFixed(2) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        async function handleUpload(e) {
            e.preventDefault();

            if (fileInput.files.length === 0) return;

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onloadstart = () => {
                uploadBtn.disabled = true;
                loadingMessage.classList.remove('hidden');
            };
            
            reader.onload = async (e) => {
                const base64Image = e.target.result; 
                
                // Set the uploaded image preview immediately
                uploadedImage.src = base64Image;

                try {
                    const response = await fetch(API_ENDPOINT, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            image_base64: base64Image 
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    // --- Display Results ---
                    const topClass = data.predicted_class_name;
                    topClassSpan.textContent = topClass;
                    recommendationP.textContent = recommendationMap[topClass] || "No specific recommendation available.";

                    const probs = data.prediction_prob || data.prediction; // Use prediction_prob if available, otherwise prediction list
                    
                    // The API response from the provided code returns `prediction` as an array of logits (before softmax).
                    // We must convert it to probabilities if the API response doesn't already contain them.
                    let probabilities = [];
                    if (data.prediction_prob) {
                         probabilities = data.prediction_prob[0];
                    } else if (Array.isArray(probs) && probs.length > 0) {
                        // If only raw logits are returned, estimate probabilities
                        // NOTE: This is a simplified client-side softmax. The API should ideally return the softmaxed values.
                        const logits = probs[0];
                        const expLogits = logits.map(Math.exp);
                        const sumExp = expLogits.reduce((a, b) => a + b, 0);
                        probabilities = expLogits.map(exp => exp / sumExp);
                    }
                    
                    // Update probability list
                    allProbsList.innerHTML = '';
                    const classProbs = classNames.map((name, i) => ({ name, prob: probabilities[i] || 0 }));
                    classProbs.sort((a, b) => b.prob - a.prob).forEach(item => {
                        const li = document.createElement('li');
                        li.innerHTML = `<strong>${item.name}:</strong> ${(item.prob * 100).toFixed(2)} %`;
                        allProbsList.appendChild(li);
                    });
                    
                    // Create the bar chart
                    createChart(probabilities);

                    uploadCard.classList.add('hidden');
                    resultCard.classList.remove('hidden');

                } catch (error) {
                    alert('Prediction failed: ' + error.message + '. Check the console for details.');
                    console.error('Prediction Error:', error);
                } finally {
                    loadingMessage.classList.add('hidden');
                    uploadBtn.disabled = false;
                }
            };
            
            reader.readAsDataURL(file); 
        }
    </script>
  </body>
</html>